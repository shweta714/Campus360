<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus360 - Student Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        // early theme fallback: apply stored theme ASAP so CSS picks it up before render
        (function(){
            try{
                const raw = localStorage.getItem('campus360_prefs');
                if(!raw) return;
                const prefs = JSON.parse(raw);
                if(prefs && prefs.theme === 'dark'){
                    try{ document.documentElement.classList.add('dark-theme'); }catch(e){}
                    try{ document.body.classList.add('dark-theme'); }catch(e){}
                    try{ document.documentElement.setAttribute('data-theme','dark'); }catch(e){}
                }
            }catch(e){}
        })();
    </script>
    <link rel="stylesheet" href="student-dashboard.css">
    <script src="theme.js" defer></script>
</head>
<body>
    <!-- App Sidebar -->
    <aside class="app-sidebar" id="appSidebar" aria-label="Main navigation">
        <nav class="sidebar-nav">
            <ul>
                <li class="sidebar-item" data-target="student-dashboard.html" title="Home">
                    <button class="sidebar-btn" data-href="student-dashboard.html">
                        <!-- Home SVG -->
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M3 10.5L12 4l9 6.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M5 10.5v7a1 1 0 0 0 1 1h3v-5h6v5h3a1 1 0 0 0 1-1v-7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span class="sidebar-label">Home</span>
                    </button>
                </li>

                <li class="sidebar-item" data-target="profile.html" title="Profile Overview">
                    <button class="sidebar-btn" data-href="profile.html">
                        <!-- User SVG -->
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M4 20a8 8 0 0 1 16 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span class="sidebar-label">Profile</span>
                    </button>
                </li>

                <li class="sidebar-item" data-target="exam-panel.html" title="Exam Panel">
                    <button class="sidebar-btn" data-href="exam-panel.html">
                        <!-- Exams SVG (book) -->
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M3 6.5A2.5 2.5 0 0 1 5.5 4H20" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M21 4v14a2 2 0 0 1-2 2H6.5A2.5 2.5 0 0 1 4 17.5V4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M8 14h8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span class="sidebar-label">Exam Panel</span>
                    </button>
                </li>
                
                    <li class="sidebar-item" data-target="courses.html" title="Resources">
                        <button class="sidebar-btn" data-href="courses.html">
                            <!-- Resources SVG -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M4 6.5A2.5 2.5 0 0 1 6.5 4H20" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="sidebar-label">Resources</span>
                        </button>
                    </li>

                <li class="sidebar-item" data-target="settings.html" title="Settings">
                    <button class="sidebar-btn" data-href="settings.html">
                        <!-- Settings SVG -->
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M19.4 15a1.8 1.8 0 0 0 .3 2l.1.1a1 1 0 0 1-1.4 1.4l-.1-.1a1.8 1.8 0 0 0-2 .3l-.2.2a1 1 0 0 1-1.4 0l-.2-.2a1.8 1.8 0 0 0-2-.3l-.2.1a1 1 0 0 1-1-.2l-.1-.1a1.8 1.8 0 0 0-.3-2l-.1-.1a1 1 0 0 1 0-1.4l.1-.1a1.8 1.8 0 0 0 .3-2l-.1-.2a1 1 0 0 1 1.1-1.4l.2.1a1.8 1.8 0 0 0 2-.3l.2-.2a1 1 0 0 1 1.4 0l.2.2a1.8 1.8 0 0 0 2 .3l.2-.1a1 1 0 0 1 1 .2l.1.1a1.8 1.8 0 0 0 .3 2l.1.1a1 1 0 0 1 0 1.4l-.1.1z" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span class="sidebar-label">Settings</span>
                    </button>
                </li>
            </ul>
        </nav>
    </aside>
    <!-- Main Content -->
    <div class="main-content">
        <!-- Theme Toggle Switch removed: toggling only from settings -->
        <!-- Top Navigation Bar removed (sidebar used instead) -->

        <!-- Dashboard Container -->
        <div class="dashboard-container">
            <!-- Dashboard Header: user topbar (shows logged-in name, settings, logout) -->
            <div class="dashboard-header">
                <div class="user-topbar">
                    <div class="user-left">
                        <div class="user-avatar" id="userAvatar" aria-hidden="true">ðŸ‘¤</div>
                        <div class="user-meta">
                            <div class="user-name" id="topbarName">Student</div>
                            <div class="user-role muted">Student portal</div>
                        </div>
                    </div>
                    <div class="user-actions">
                        <a href="settings.html" class="btn" title="Settings">Settings</a>
                        <button onclick="logout()" class="btn logout-btn" title="Logout">Logout</button>
                    </div>
                </div>
            </div>

            <!-- Main two-column layout: left content grid, right updates + chatbot -->
            <div class="dashboard-main">
                <div class="left-column">
                    <!-- Welcome banner -->
                    <div class="welcome-card left-card">
                        <div class="welcome-inner">
                            <div>
                                <h2 style="margin:0;">Hello, <span id="userName">Student</span>!</h2>
                                <p class="muted" style="margin:6px 0 0;">Ready for your day?</p>
                            </div>
                            <div>
                                <button class="btn" title="Notifications" id="notifBtn">
                                    <!-- notification SVG -->
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0 1 18 14.158V11a6 6 0 1 0-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Overview grid: two-column card layout -->
                    <div class="overview-grid">
                        <section class="card big-card next-exam left-card highlight-purple">
                            <h3>Next Exam</h3>
                            <div class="exam-progress">
                                <div class="exam-progress-track">
                                    <div class="exam-progress-fill" style="width:36%;"></div>
                                </div>
                                <div class="muted" style="margin-top:8px;">Database Systems (DDMS) - 3 Days Left</div>
                            </div>
                        </section>

                        <section class="card small-card courses-card left-card highlight-blue">
                            <h3>Courses</h3>
                            <div id="recentCourse" style="margin-top:8px;">
                                <a id="recentCourseLink" href="#" class="course-tile" aria-label="Open recent course">
                                    <div class="tile-top">
                                        <div style="display:flex;gap:12px;align-items:center">
                                            <div class="tile-icon" aria-hidden="true">DS</div>
                                            <div style="min-width:0">
                                                <div id="recentCourseTitle" class="tile-title">No recent course</div>
                                                <div class="tile-instructor muted">No recent attempts</div>
                                            </div>
                                        </div>
                                        <div class="tile-code" id="recentCourseBadge">--</div>
                                    </div>
                                    <div class="progress-row">
                                        <div class="course-progress" style="flex:1;margin-right:12px">
                                            <div id="recentCourseProgress" class="progress-fill" style="width:0%"></div>
                                        </div>
                                        <div class="muted" id="recentCoursePercent">0%</div>
                                    </div>
                                </a>
                            </div>
                        </section>

                        <!-- timetable card removed (duplicate) -->

                        <section class="card map-card seating-card left-card highlight-orange">
                            <h3>Seating Plan</h3>
                            <div id="reservedSeat" class="reserved-seat">
                                <div class="muted">Loading reserved seat...</div>
                            </div>
                        </section>

                        <section class="card table-card left-card highlight-teal">
                            <h3>Timetable</h3>
                            <div style="margin-top:8px;overflow:auto;">
                                <table>
                                    <tr><td>Mon</td><td>AI</td><td>9:00</td></tr>
                                    <tr><td>Tue</td><td>DBMS</td><td>11:00</td></tr>
                                </table>
                            </div>
                        </section>
                    </div>

                    <!-- Large footer card removed per request -->
                </div>

                <!-- Right column: Important updates + Chatbot -->
                <div class="right-column">
                    <aside class="updates-card">
                        <h4>Important Updates</h4>
                        <ul class="updates-list">
                            <li style="display:flex;gap:12px;align-items:flex-start;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0 1 18 14.158V11a6 6 0 1 0-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5" stroke="#7ec1ff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg><div>New Seating Updates Posted</div></li>
                            <li style="display:flex;gap:12px;align-items:flex-start;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M18 8c0-1.657-1.343-3-3-3H9a3 3 0 0 0 0 6h6c1.657 0 3-1.343 3-3zM6 20v-6" stroke="#7ec1ff" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg><div>Final Exam Schedule Released</div></li>
                        </ul>
                        <!-- Chat button removed; chatbot opens when robot face is clicked -->
                    </aside>

                    <div id="chatOuter" class="chat-outer">
                        <div class="chat-header">
                            <div>
                                <strong>Campus360 Chat Assistant</strong>
                                <div class="muted">Ask about timetable, seating, or courses.</div>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px">
                                <button id="clearChat" class="clear-chat" title="Clear chat (Ctrl+K)">Clear</button>
                                <div style="font-size:20px;">ðŸ¤–</div>
                            </div>
                        </div>

                        <div id="chatWindow" class="chat-window">
                            <!-- messages appear here -->
                        </div>

                        <div class="chat-input-row">
                            <input id="chatInput" placeholder="Type a message..." />
                            <button id="sendChat" class="btn primary">Send</button>
                        </div>
                    </div>

                    <div class="chat-assistant-fab">
                        <div id="chatFab" role="button" aria-label="Open Chat" class="chat-fab">ðŸ¤–</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Navbar active state
        function setActiveNav(element) {
            document.querySelectorAll('.navbar-menu li').forEach(function (li) {
                li.classList.remove('active');
            });
            element.classList.add('active');
            // ...existing code...

        }

        // Use the central theme runtime API. Call it with the expected string values
        // ('dark' or 'light') so we don't accidentally pass booleans that confuse
        // the shared `theme.js` API. PREF_KEY is used to read persisted preference.
        const PREF_KEY = 'campus360_prefs';

        // Logout function: clear client storage and go to login page
        function logout() {
            try {
                sessionStorage.clear();
                localStorage.removeItem('authToken');
            } catch (e) { }
            window.location.href = 'login.html';
        }

        // Simple local chatbot (mock) saved in localStorage
        (function () {
            const CHAT_KEY = 'campus360_chat_msgs';
            function readMsgs() { try { return JSON.parse(localStorage.getItem(CHAT_KEY) || '[]'); } catch (e) { return []; } }
            function saveMsgs(m) { localStorage.setItem(CHAT_KEY, JSON.stringify(m)); }
            function renderMsgs() {
                const win = document.getElementById('chatWindow');
                if (!win) return;
                win.innerHTML = '';
                const msgs = readMsgs();
                msgs.forEach(m => {
                    const d = document.createElement('div');
                    d.style.marginBottom = '8px';
                    const wrapper = document.createElement('div');
                    wrapper.style.textAlign = (m.role === 'user') ? 'right' : 'left';
                    const span = document.createElement('span');
                    span.className = 'msg ' + (m.role === 'user' ? 'user' : 'bot');
                    span.textContent = escapeHtml(m.text);
                    wrapper.appendChild(span);
                    d.appendChild(wrapper);
                    win.appendChild(d);
                });
                win.scrollTop = win.scrollHeight;
            }
            function escapeHtml(s) { return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
            async function mockReply(text) {
                // Professional reply generator that attempts to answer from site data (timetable/seating)
                text = (text || '').trim();
                const prof = (function () { try { return JSON.parse(localStorage.getItem('campus360_profile') || 'null'); } catch (e) { return null; } })();
                const name = prof && (prof.name || prof.fullName || prof.firstName) ? (prof.name || prof.fullName || prof.firstName) : null;
                const greet = name ? `Hello ${name},` : 'Hello,';
                if (!text) return `${greet} how may I assist you today? I can help with timetable, seating, courses, and resources.`;

                const lower = text.toLowerCase();

                // Helper: attempt to load JS arrays/objects from other pages (timetable.html, seating.html)
                async function fetchDataOnce(url, re) {
                    try {
                        const cacheKey = `_cache_${url}`;
                        if (window[cacheKey]) return window[cacheKey];
                        const res = await fetch(url, { cache: 'no-store' });
                        if (!res.ok) throw new Error('fetch failed');
                        const txt = await res.text();
                        const m = txt.match(re);
                        if (!m) return null;
                        // evaluate the JS literal safely using Function
                        const val = (new Function('return ' + m[1]))();
                        window[cacheKey] = val;
                        return val;
                    } catch (e) { return null; }
                }

                // Timetable / exam queries: try to find EXAMS in timetable.html
                if (/\b(timetable|schedule|exam|date|when|time)\b/.test(lower)) {
                    const EXAMS = await fetchDataOnce('timetable.html', /(?:var|const|let)\s+EXAMS\s*=\s*(\[[\s\S]*?\]);/m);
                    if (EXAMS && Array.isArray(EXAMS) && EXAMS.length) {
                        // search for exam by keywords in user text
                        const hits = EXAMS.filter(e => JSON.stringify(e).toLowerCase().includes(lower));
                        if (hits.length === 1) {
                            const e = hits[0];
                            const parts = [];
                            if (e.course) parts.push(`Course: ${e.course}`);
                            if (e.title) parts.push(`Exam: ${e.title}`);
                            if (e.date) parts.push(`Date: ${e.date}`);
                            if (e.time) parts.push(`Time: ${e.time}`);
                            if (e.location) parts.push(`Location: ${e.location}`);
                            return `${greet} here is the information I found:
${parts.join('\n')}
If you need further details, tell me the course or exact exam name.`;
                        }
                        if (hits.length > 1) {
                            const list = hits.slice(0, 4).map(h => (h.title || h.course || JSON.stringify(h)).toString()).join('; ');
                            return `${greet} I found several matching exams: ${list}. Please specify which one you mean.`;
                        }
                        // no hits but we have data
                        return `${greet} I can see the timetable data but could not find a match for "${text}". Please provide the course name or exact exam title.`;
                    }
                    // couldn't load timetable data
                    return `${greet} I couldn't access the timetable from here. Please tell me the course or exact exam name (for example "DBMS exam") and I will search within my available data.`;
                }

                // Seating queries: attempt to read seating maps
                if (/\b(seat|seating|where is my seat|seat number|hall)\b/.test(lower)) {
                    const MAPS = await fetchDataOnce('seating.html', /(?:var|const|let)\s+SEATING_MAPS\s*=\s*(\{[\s\S]*?\});/m);
                    if (MAPS) {
                        // try to match by roll or name in user text
                        const token = text.replace(/[^a-z0-9]/gi, ' ').trim().toLowerCase();
                        for (const dateKey of Object.keys(MAPS)) {
                            const courses = MAPS[dateKey];
                            for (const c of Object.keys(courses)) {
                                const rows = courses[c];
                                for (const r = 0; r < rows.length; r++) {
                                    for (const col = 0; col < rows[r].length; col++) {
                                        const cell = rows[r][col];
                                        if (!cell) continue;
                                        if (JSON.stringify(cell).toLowerCase().includes(token)) {
                                            return `${greet} I found a seating entry for "${text}" on ${dateKey} in course ${c}: Row ${r + 1}, Seat ${col + 1} (${cell}).`;
                                        }
                                    }
                                }
                            }
                        }
                        return `${greet} I can access seating maps but could not find a match for "${text}". Provide a full name or roll number to improve the search.`;
                    }
                    return `${greet} I don't have direct access to seating data from this page. Share your full name or roll number and I'll try to match it.`;
                }

                // Course / enrollment queries
                if (/\b(course|enroll|enrolled|syllabus|resources|assignments)\b/.test(lower)) {
                    return `${greet} please tell me the course name you are interested in (for example: "DBMS"). I will summarize available resources and links.`;
                }

                // Help / contact queries
                if (/\b(help|support|contact|office|administration|who to contact)\b/.test(lower)) {
                    return `${greet} describe the issue briefly and I will suggest the best contact or next steps (for example: "I need to change exam slot").`;
                }

                // Greetings
                if (/\b(hi|hello|hey|good morning|good afternoon|good evening)\b/.test(lower)) {
                    return `${greet} I'm Campus360 Assistant â€” how may I help you with your timetable, seating, courses, or resources today?`;
                }

                // Polite fallback asking for clarification and examples
                return `${greet} I didn't fully understand that. Could you please rephrase or provide more details? Examples you can try: "When is DBMS exam?", "Find seat for Roll 12345", or "DBMS resources".`;
            }
            function sizeChat() { 
                const outer = document.getElementById('chatOuter');
                if (!outer) return;
                const topOffset = outer.getBoundingClientRect().top;
                const avail = Math.max(200, window.innerHeight - topOffset - 40);
                // set maxHeight so chat stays within viewport; internal window will scroll
                outer.style.maxHeight = avail + 'px';
                const win = document.getElementById('chatWindow');
                if (win) {
                    // reserve ~120px for header+input
                    win.style.maxHeight = Math.max(120, avail - 120) + 'px';
                }
            }
            document.addEventListener('DOMContentLoaded', function () {
                sizeChat(); renderMsgs();
                const send = document.getElementById('sendChat');
                const input = document.getElementById('chatInput');
                const clearBtn = document.getElementById('clearChat');

                if (send && input) {
                    send.addEventListener('click', function () {
                        (async function () {
                            const v = input.value.trim(); if (!v) return;
                            const msgs = readMsgs(); msgs.push({ role: 'user', text: v }); saveMsgs(msgs); renderMsgs(); input.value = '';
                            // small typing delay to feel natural
                            await new Promise(r => setTimeout(r, 420));
                            try {
                                const reply = await mockReply(v);
                                const m = readMsgs(); m.push({ role: 'bot', text: reply }); saveMsgs(m); renderMsgs();
                            } catch (e) { const m = readMsgs(); m.push({ role: 'bot', text: 'Sorry, I could not process that request.' }); saveMsgs(m); renderMsgs(); }
                        })();
                    });
                    input.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); send.click(); } });
                }

                if (clearBtn) { clearBtn.addEventListener('click', function () { if (!confirm('Clear chat history?')) return; saveMsgs([]); renderMsgs(); }); }

                // keyboard shortcut: Ctrl+K to clear chat
                document.addEventListener('keydown', function (e) { if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); if (confirm('Clear chat history?')) { saveMsgs([]); renderMsgs(); } } });

                window.addEventListener('resize', sizeChat);
            });
        })();

        // Auto-apply persisted theme (use central runtime API).
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(function () {
                try {
                    const raw = localStorage.getItem(PREF_KEY);
                    let theme = 'light';
                    if (raw) {
                        const prefs = JSON.parse(raw);
                        theme = prefs.theme === 'dark' ? 'dark' : 'light';
                    }
                    if (window.setTheme && typeof window.setTheme === 'function') {
                        try { window.setTheme(theme); } catch (e) { /* ignore */ }
                    } else {
                        // safe fallback if runtime missing: apply classes directly
                        try { document.documentElement.classList.toggle('dark-theme', theme === 'dark'); } catch (e) {}
                        try { if (document.body) document.body.classList.toggle('dark-theme', theme === 'dark'); } catch (e) {}
                        try { document.documentElement.setAttribute('data-theme', theme); } catch (e) {}
                    }
                } catch (e) {
                    try { if (window.setTheme) window.setTheme('light'); } catch (e) {}
                }
            }, 0);
        });
        
                // Sidebar navigation: active state and click handling
                (function () {
                    function initSidebar() {
                        const sidebar = document.getElementById('appSidebar');
                        if (!sidebar) return;
                        const items = sidebar.querySelectorAll('.sidebar-item');
                        const current = window.location.pathname.split('/').pop() || 'student-dashboard.html';
                        items.forEach(li => {
                            const target = li.getAttribute('data-target');
                            if (target === current) li.classList.add('active');
                            const btn = li.querySelector('.sidebar-btn');
                            if (btn) {
                                btn.addEventListener('click', function () {
                                    const href = btn.getAttribute('data-href');
                                    // set active state
                                    items.forEach(x => x.classList.remove('active'));
                                    li.classList.add('active');
                                    // navigate
                                    if (href) window.location.href = href;
                                });
                                // keyboard: Enter/Space
                                btn.addEventListener('keydown', function (e) {
                                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); }
                                });
                            }
                        });
                    }
                    document.addEventListener('DOMContentLoaded', initSidebar);
                })();
    </script>
            <script>
                // populate topbar and greeting with logged-in user's name/avatar
                (function () {
                    function populateUserTopbar() {
                        try {
                            const raw = localStorage.getItem('campus360_profile');
                            const prof = raw ? JSON.parse(raw) : null;
                            const name = prof && (prof.name || prof.fullName || prof.firstName) ? (prof.name || prof.fullName || prof.firstName) : (localStorage.getItem('campus360_user') || 'Student');
                            const nameEls = document.querySelectorAll('#userName, #topbarName');
                            nameEls.forEach(el => { if (el) el.innerText = name; });

                            const avatar = document.getElementById('userAvatar');
                            if (avatar) {
                                if (prof && prof.avatarUrl) {
                                    avatar.innerHTML = '';
                                    const img = document.createElement('img');
                                    img.src = prof.avatarUrl;
                                    img.alt = name;
                                    img.style.width = '100%'; img.style.height = '100%'; img.style.borderRadius = '50%'; img.style.objectFit = 'cover';
                                    avatar.appendChild(img);
                                } else {
                                    const initials = (name.split(' ').map(n => n[0]).join('') || 'S').slice(0,2).toUpperCase();
                                    avatar.textContent = initials;
                                }
                            }
                        } catch (e) { /* ignore */ }
                    }
                    document.addEventListener('DOMContentLoaded', populateUserTopbar);

                    // chatbot initially closed; open only when robot FAB is clicked
                    document.addEventListener('DOMContentLoaded', function () {
                        const chatOuter = document.getElementById('chatOuter');
                        if (chatOuter) chatOuter.classList.remove('visible');

                        const fab = document.getElementById('chatFab');
                        if (fab) {
                            fab.addEventListener('click', function () {
                                try {
                                    if (!chatOuter) return;
                                    const input = document.getElementById('chatInput');
                                    const isVisible = chatOuter.classList.contains('visible');
                                            if (isVisible) {
                                                chatOuter.classList.remove('visible');
                                            } else {
                                                chatOuter.classList.add('visible');
                                                // do not scroll the page; constrain chat height so it stays within the first screen
                                                setTimeout(() => { if (input) input.focus(); }, 300);
                                            }
                                } catch (e) { }
                            });
                        }

                        // notification button placeholder
                        const nb = document.getElementById('notifBtn');
                        if (nb) nb.addEventListener('click', function () { alert('No new notifications.'); });
                        // populate dashboard cards (recent course, reserved seat)
                            try {
                                const recentRaw = localStorage.getItem('campus360_recent_course');
                                const recent = recentRaw ? JSON.parse(recentRaw) : null;
                                const recentTitle = document.getElementById('recentCourseTitle');
                                const recentProg = document.getElementById('recentCourseProgress');
                                const recentPercent = document.getElementById('recentCoursePercent');
                                const recentBadge = document.getElementById('recentCourseBadge');
                                const recentLink = document.getElementById('recentCourseLink');
                                if (recent && recentTitle) {
                                    recentTitle.innerText = recent.title || 'Recent Course';
                                    if (recentProg) recentProg.style.width = (Number(recent.progress) || 0) + '%';
                                    if (recentPercent) recentPercent.innerText = (Number(recent.progress) || 0) + '%';
                                    if (recentBadge) recentBadge.innerText = recent.code || ((recent.title||'').slice(0,2).toUpperCase() || '--');
                                    if (recentLink) recentLink.href = 'exam-panel.html';
                                } else if (recentTitle) {
                                    recentTitle.innerText = 'No recent course attempted';
                                    if (recentProg) recentProg.style.width = '0%';
                                    if (recentPercent) recentPercent.innerText = '0%';
                                    if (recentBadge) recentBadge.innerText = '--';
                                    if (recentLink) recentLink.href = '#';
                                }
                            

                            const seatRaw = localStorage.getItem('campus360_reserved_seat');
                            const seat = seatRaw ? JSON.parse(seatRaw) : null;
                            const seatBox = document.getElementById('reservedSeat');
                            if (seatBox) {
                                if (seat) {
                                    seatBox.innerHTML = `<div class="seating-info"><div><strong>${seat.course || 'Course'}</strong> â€” <span class="muted">${seat.date || ''} ${seat.time || ''}</span></div><div class="seat-badge">Seat ${seat.seat || 'N/A'}</div></div>`;
                                } else {
                                    seatBox.innerHTML = `<div class="muted">No reserved seat found for upcoming exams.</div>`;
                                }
                            }
                        } catch (e) { /* ignore */ }
                    });
                })();
            </script>
</body>

</html>